<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Tareas Python</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            max-width: 600px;
            margin: 2rem auto;
            padding: 0 1rem;
            background-color: #f0f2f5;
            color: #333;
        }

        .card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h2 {
            margin-top: 0;
            color: #1a73e8;
        }

        input,
        button,
        textarea {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            box-sizing: border-box;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        button {
            background-color: #1a73e8;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        button:hover {
            background-color: #1557b0;
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-danger {
            background-color: #dc3545;
        }

        .btn-warning {
            background-color: #ffc107;
            color: black;
        }

        .oculto {
            display: none;
        }

        .tarea-item {
            background: #fff;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .acciones {
            display: flex;
            gap: 5px;
        }

        .acciones button {
            width: auto;
            padding: 5px 12px;
            font-size: 0.85rem;
            margin-top: 0;
        }

        /* Estilo para items comprados */
        .comprado {
            text-decoration: line-through;
            color: #888;
            background-color: #f0f0f0;
        }

        /* Ajuste para que el checkbox se vea bien */
        .item-lista {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }

        /* CORRECCI√ìN: Evitar que el checkbox ocupe el 100% del ancho */
        input[type="checkbox"] {
            width: auto;
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body>

    <div id="login-screen" class="card">
        <h2>üîê Iniciar Sesi√≥n</h2>
        <input type="text" id="username" placeholder="Usuario">
        <input type="password" id="password" placeholder="Contrase√±a">
        <button onclick="hacerLogin()">Entrar</button>
        <p id="mensaje-login" style="color: red; text-align: center;"></p>
    </div>

    <div id="app-screen" class="card oculto">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div style="display: flex; gap: 10px;">
                <button onclick="mostrarPesta√±a('tareas')" id="tab-tareas" class="btn-secondary">Mis Tareas</button>
                <button onclick="mostrarPesta√±a('listas')" id="tab-listas" class="btn-secondary">Listas de
                    Compra</button>
            </div>
            <button onclick="cerrarSesion()" class="btn-danger" style="width: auto;">Salir</button>
        </div>

        <div id="vista-tareas">
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h3 id="titulo-formulario" style="margin-top:0">Nueva Tarea</h3>
                <input id="input-titulo" placeholder="T√≠tulo de la tarea">
                <input id="input-desc" placeholder="Descripci√≥n (Opcional)">
                <div style="display: flex; gap: 10px;">
                    <button onclick="guardarTarea()" id="btn-guardar">Crear Tarea</button>
                    <button onclick="cancelarEdicion()" id="btn-cancelar" class="btn-secondary oculto">Cancelar</button>
                </div>
            </div>
            <div id="lista-tareas"></div>
        </div>

        <div id="vista-listas" class="oculto">
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top:0; color: #0d47a1;">Nueva Lista de Compra</h3>

                <input id="lista-titulo" placeholder="Nombre (ej: Mercadona Semanal)" style="font-weight: bold;">

                <div id="items-container" style="margin-top: 15px; border-left: 3px solid #2196f3; padding-left: 10px;">
                    <p style="margin: 5px 0; font-size: 0.9em; color: #666;">Productos:</p>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button onclick="agregarInputProducto()" class="btn-secondary" style="background-color: #2196f3;">+
                        A√±adir Producto</button>
                    <button onclick="guardarListaCompra()" style="background-color: #0d47a1;">Guardar Lista
                        Completa</button>
                </div>
            </div>

            <div id="contenedor-listas"></div>
        </div>
    </div>

    <script>
        let nombreListaEditando = null; // Guardar√° el nombre original si estamos editando
        let misListas = []; // <--- Aqu√≠ guardaremos copia de los datos
        // Detecta si es localhost, IP local, o si est√°s abriendo el archivo directamente (file:)
        const esLocal = window.location.hostname === '127.0.0.1' ||
            window.location.hostname === 'localhost' ||
            window.location.protocol === 'file:';

        const API_URL = esLocal
            ? "http://127.0.0.1:8000"                  // Backend Local
            : "https://gestortareas-ws.onrender.com"; // Backend Nube (Render)

        console.log("Conectando a:", API_URL); // Para que veas en la consola (F12) cu√°l eligi√≥

        let token = localStorage.getItem("token_accesible");

        // Variables para controlar la edici√≥n
        let modoEdicion = false;
        let tituloOriginalEditando = "";

        if (token) mostrarApp();

        // --- AUTENTICACI√ìN ---
        async function hacerLogin() {
            const user = document.getElementById("username").value;
            const pass = document.getElementById("password").value;
            const datos = new URLSearchParams({ username: user, password: pass });

            try {
                const res = await fetch(`${API_URL}/token`, {
                    method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: datos
                });
                if (!res.ok) throw new Error("Datos incorrectos");
                const json = await res.json();
                token = json.access_token;
                localStorage.setItem("token_accesible", token);
                mostrarApp();
            } catch (e) { document.getElementById("mensaje-login").innerText = e.message; }
        }

        // --- GESTI√ìN DE TAREAS ---

        // 1. CARGAR
        async function cargarTareas() {
            const res = await fetch(`${API_URL}/tareas`, { headers: { "Authorization": `Bearer ${token}` } });
            const tareas = await res.json();
            const divLista = document.getElementById("lista-tareas");
            divLista.innerHTML = "";

            tareas.forEach(t => {
                const completadaStyle = t.completada ? "text-decoration: line-through; color: gray;" : "";
                const item = document.createElement("div");
                item.className = "tarea-item";
                item.innerHTML = `
                    <span style="${completadaStyle}">
                        <strong>${t.titulo}</strong><br>
                        <small>${t.descripcion || ""}</small>
                    </span>
                    <div class="acciones">
                        <button class="btn-warning" onclick="iniciarEdicion('${t.titulo}', '${t.descripcion || ''}')">Editar</button>
                        <button class="btn-danger" onclick="borrarTarea('${t.titulo}')">Borrar</button>
                    </div>
                `;
                divLista.appendChild(item);
            });
        }

        // 2. GUARDAR (Sirve para CREAR y EDITAR)
        async function guardarTarea() {
            const titulo = document.getElementById("input-titulo").value;
            const desc = document.getElementById("input-desc").value;

            if (!titulo) return alert("El t√≠tulo es obligatorio");

            let url, metodo, cuerpo;

            if (modoEdicion) {
                // MODO EDITAR (PUT)
                // Nota: Usamos tituloOriginalEditando en la URL para identificar cu√°l cambiar
                url = `${API_URL}/tareas/${tituloOriginalEditando}`;
                metodo = "PUT";
                cuerpo = { titulo: titulo, descripcion: desc }; // Podemos cambiar el t√≠tulo tambi√©n
            } else {
                // MODO CREAR (POST)
                url = `${API_URL}/tareas`;
                metodo = "POST";
                cuerpo = { titulo: titulo, descripcion: desc };
            }

            const res = await fetch(url, {
                method: metodo,
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(cuerpo)
            });

            if (res.ok) {
                cancelarEdicion(); // Limpia el formulario
                cargarTareas();    // Recarga la lista
            } else {
                const error = await res.json();
                alert("Error: " + error.detail);
            }
        }

        // 3. BORRAR
        async function borrarTarea(titulo) {
            if (!confirm("¬øBorrar tarea?")) return;
            await fetch(`${API_URL}/tareas/eliminar?titulo=${titulo}`, {
                method: "DELETE", headers: { "Authorization": `Bearer ${token}` }
            });
            cargarTareas();
        }

        // --- FUNCIONES DE LA INTERFAZ (UI) ---

        function iniciarEdicion(titulo, descripcion) {
            modoEdicion = true;
            tituloOriginalEditando = titulo; // Guardamos el t√≠tulo viejo para saber a qui√©n hacer el UPDATE

            // Rellenamos el formulario con los datos existentes
            document.getElementById("input-titulo").value = titulo;
            document.getElementById("input-desc").value = descripcion;

            // Cambiamos visualmente el bot√≥n
            document.getElementById("titulo-formulario").innerText = "Editar Tarea";
            document.getElementById("btn-guardar").innerText = "Actualizar Cambios";
            document.getElementById("btn-guardar").className = "btn-warning";
            document.getElementById("btn-cancelar").classList.remove("oculto");
        }

        function cancelarEdicion() {
            modoEdicion = false;
            tituloOriginalEditando = "";
            document.getElementById("input-titulo").value = "";
            document.getElementById("input-desc").value = "";

            // Restauramos el formulario al modo "Crear"
            document.getElementById("titulo-formulario").innerText = "Nueva Tarea";
            document.getElementById("btn-guardar").innerText = "Crear Tarea";
            document.getElementById("btn-guardar").className = ""; // Quitar clase warning
            document.getElementById("btn-cancelar").classList.add("oculto");
        }

        function mostrarApp() {
            document.getElementById("login-screen").classList.add("oculto");
            document.getElementById("app-screen").classList.remove("oculto");
            mostrarPesta√±a('tareas');
        }

        // --- LOGICA DE PESTA√ëAS ---
        function mostrarPesta√±a(tab) {
            document.getElementById("vista-tareas").classList.add("oculto");
            document.getElementById("vista-listas").classList.add("oculto");

            // Quitamos estilo activo a botones
            document.getElementById("tab-tareas").style.backgroundColor = "#6c757d";
            document.getElementById("tab-listas").style.backgroundColor = "#6c757d";

            if (tab === 'tareas') {
                document.getElementById("vista-tareas").classList.remove("oculto");
                document.getElementById("tab-tareas").style.backgroundColor = "#1a73e8";
                cargarTareas();
            } else {
                document.getElementById("vista-listas").classList.remove("oculto");
                document.getElementById("tab-listas").style.backgroundColor = "#1a73e8";
                cargarListas();
            }
        }

        // --- LOGICA DE LISTAS DE COMPRA ---

        // 1. A√±adir una fila de inputs (Producto + Cantidad) en el formulario
        // Ahora acepta par√°metros opcionales (nombre y cantidad)
        function agregarInputProducto(nombre = "", cantidad = 1) {
            const container = document.getElementById("items-container");
            const div = document.createElement("div");
            div.style.display = "flex";
            div.style.gap = "10px";
            div.style.marginBottom = "5px";

            // F√≠jate en los value="${...}"
            div.innerHTML = `
                <input class="item-nombre" placeholder="Producto" value="${nombre}" style="margin-top:0">
                <input type="number" class="item-cant" placeholder="Cant." value="${cantidad}" style="width: 80px; margin-top:0">
                <button onclick="this.parentElement.remove()" style="background: #dc3545; width: auto; margin-top:0">X</button>
            `;
            container.appendChild(div);
        }

        // 2. Guardar la lista (Recorrer los inputs y montar el JSON)
        async function guardarListaCompra() {
            const titulo = document.getElementById("lista-titulo").value;
            if (!titulo) return alert("Ponle un nombre a la lista");

            // Recopilamos items (igual que antes)
            const nombres = document.querySelectorAll(".item-nombre");
            const cantidades = document.querySelectorAll(".item-cant");
            const items = [];

            for (let i = 0; i < nombres.length; i++) {
                if (nombres[i].value) {
                    items.push({
                        producto: nombres[i].value,
                        cantidad: parseInt(cantidades[i].value),
                        comprado: false
                    });
                }
            }
            if (items.length === 0) return alert("A√±ade al menos un producto");

            const payload = { titulo: titulo, items: items };

            let url = `${API_URL}/listas`;
            let method = "POST";

            // --- CAMBIO CLAVE: SI ESTAMOS EDITANDO ---
            if (nombreListaEditando) {
                // Usamos la ruta PUT y a√±adimos el nombre antiguo a la URL
                url = `${API_URL}/listas/${nombreListaEditando}`;
                method = "PUT";
            }
            // -----------------------------------------

            const res = await fetch(url, {
                method: method,
                headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert(nombreListaEditando ? "Lista actualizada!" : "Lista creada!");

                // Limpieza y Reset
                document.getElementById("lista-titulo").value = "";
                document.getElementById("items-container").innerHTML = '<p style="margin: 5px 0; font-size: 0.9em; color: #666;">Productos:</p>';
                agregarInputProducto();

                // Volvemos al modo normal (Crear)
                nombreListaEditando = null;
                const btnGuardar = document.querySelector("button[onclick='guardarListaCompra()']");
                btnGuardar.innerText = "Guardar Lista Completa";
                btnGuardar.style.backgroundColor = "#0d47a1";

                cargarListas();
            } else {
                const errorTexto = await res.text();
                alert("Error: " + errorTexto);
            }
        }

        // 3. Cargar y Pintar las listas
        async function cargarListas() {
            try {
                const res = await fetch(`${API_URL}/listas`, { headers: { "Authorization": `Bearer ${token}` } });
                if (!res.ok) throw new Error("Error cargando listas");

                misListas = await res.json();

                const container = document.getElementById("contenedor-listas");
                container.innerHTML = "";

                misListas.forEach((lista) => {
                    let htmlItems = "";

                    lista.items.forEach((item, i) => {
                        const check = item.comprado ? "checked" : "";
                        const clase = item.comprado ? "comprado" : "";

                        // F√≠jate bien en el </li> al final de este bloque
                        htmlItems += `
                            <li class="item-lista ${clase}">
                                <input type="checkbox" ${check} onchange="cambiarEstadoItem('${lista.titulo}', ${i})">
                                <span>${item.cantidad}x ${item.producto}</span>
                            </li>`; // <--- ¬°ASEG√öRATE DE QUE ESTE </li> EST√â AQU√ç!
                    });

                    // Preparamos los datos para el bot√≥n editar
                    const itemsJson = JSON.stringify(lista.items).replace(/"/g, "&quot;");

                    const card = document.createElement("div");
                    card.className = "card";
                    card.style.borderLeft = "5px solid #1a73e8";

                    card.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <h3 style="margin:0">üõí ${lista.titulo}</h3>
                            <div style="display:flex; gap:5px">
                                <button onclick="editarLista('${lista.titulo}', ${itemsJson})" class="btn-warning" style="width:auto; padding:5px 10px;">‚úèÔ∏è</button>
                                <button onclick="borrarLista('${lista.titulo}')" class="btn-danger" style="width:auto; padding:5px 10px;">üóëÔ∏è</button>
                            </div>
                        </div>
                        <ul style="padding-left: 0; list-style: none;">${htmlItems}</ul>
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                console.error(error);
            }
        }

        // 4. Borrar lista
        async function borrarLista(titulo) {
            if (!confirm("¬øSeguro que quieres borrar la lista " + titulo + "?")) return;

            const res = await fetch(`${API_URL}/listas?titulo=${titulo}`, {
                method: "DELETE",
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (res.ok) {
                cargarListas(); // Recargamos para que desaparezca
            } else {
                alert("Error al borrar la lista");
            }
        }

        // 5. Editar lista
        function editarLista(titulo, items) {
            // 1. Cambiar estado a "Modo Edici√≥n"
            nombreListaEditando = titulo;
            document.getElementById("lista-titulo").value = titulo;

            // Cambiamos el texto del bot√≥n para que el usuario sepa que est√° editando
            const btnGuardar = document.querySelector("button[onclick='guardarListaCompra()']");
            btnGuardar.innerText = "Actualizar Lista";
            btnGuardar.style.backgroundColor = "#ff9800"; // Naranja para indicar cambio

            // 2. Limpiar el formulario actual
            const container = document.getElementById("items-container");
            container.innerHTML = '<p style="margin: 5px 0; font-size: 0.9em; color: #666;">Productos:</p>';

            // 3. Rellenar con los productos de la lista seleccionada
            // (Como 'items' puede llegar como string raro desde el HTML, a veces hay que parsearlo, 
            // pero lo pasaremos como objeto directo desde cargarListas)
            items.forEach(item => {
                agregarInputProducto(item.producto, item.cantidad);
            });

            // Llevamos al usuario arriba del todo para que vea el formulario
            document.getElementById("vista-listas").scrollIntoView({ behavior: "smooth" });
        }

        // 6. Cambiar estado item
        async function cambiarEstadoItem(tituloLista, indiceItem) {
            // 1. Buscar la lista en nuestra variable local
            const lista = misListas.find(l => l.titulo === tituloLista);
            if (!lista) return;

            // 2. Cambiar el estado (Si era true pasa a false, y viceversa)
            lista.items[indiceItem].comprado = !lista.items[indiceItem].comprado;

            // 3. Enviar la actualizaci√≥n al servidor (Silenciosamente)
            // Reutilizamos la misma l√≥gica que en 'guardarListaCompra' pero sin alertas molestas
            const res = await fetch(`${API_URL}/listas/${tituloLista}`, {
                method: "PUT",
                headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify(lista) // Enviamos la lista entera con el cambio
            });

            if (res.ok) {
                // Solo recargamos para ver el efecto visual (tachado)
                cargarListas();
            } else {
                alert("Error al actualizar estado");
            }
        }

        // Cerrar sesi√≥n
        function cerrarSesion() {
            localStorage.removeItem("token_accesible");
            location.reload();
        }
    </script>
</body>

</html>